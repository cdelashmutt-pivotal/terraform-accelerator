accelerator:
  displayName: Azure AKS with Tanzu Application Platform
  description: Terraform scripts and kapp-controller resources to bootstrap TAP for an organizational unit
  iconUrl: https://tanzu.vmware.com/developer/images/icons/icon-tap.svg
  tags:
  - infrastructure
  - tanzu
  - azure
  - aks

  options:
  - name: businessUnit
    label: Business Unit
    inputType: select
    choices:
    - value: gbs
      text: GBS
    - value: account-processing
      text: Account Processing
    - value: risk-management
      text: Risk Management
    - value: fts
      text: FTS
    defaultValue: gbs
    required: true

  - name: devEnvironment
    label: Development
    inputType: checkbox
    dataType: boolean

  - name: devTapProfile
    label: Development Cluster TAP Profile
    inputType: select
    dependsOn:
      name: devEnvironment
      value: true
    choices:
    - value: iterate
      text: Iterate
    - value: full
      text: Full
    defaultValue: iterate

  - name: devNetwork
    label: Network for Development Cluster TAP Profile
    inputType: select
    dependsOn:
      name: devEnvironment
      value: true
    choices:
    - value: net1
      text: network1
    - value: net2
      text: network2
    defaultValue: net1

  - name: qaEnvironment
    label: QA
    inputType: checkbox
    dataType: boolean
    defaultValue: false

  - name: qaNetwork
    label: Network for QA Cluster TAP Profile
    inputType: select
    dependsOn:
      name: qaEnvironment
      value: true
    choices:
    - value: net1
      text: network1
    - value: net2
      text: network2
    defaultValue: net1

  - name: prodEnvironment
    label: Production
    inputType: checkbox
    dataType: boolean
    defaultValue: false

  - name: prodNetwork
    label: Network for Staging and Prod Cluster TAP Profile
    inputType: select
    dependsOn:
      name: prodEnvironment
      value: true
    choices:
    - value: net1
      text: network1
    - value: net2
      text: network2
    defaultValue: net1

  - name: centralClusterIngress
    label: Central Cluster Ingress Domain
    inputType: text
    dataType: string
    defaultValue: central.azure.grogscave.net

engine:
  merge:
  - include: [".gitignore", "custom-resources/**/*", "overlays/**/*"]
 
  - include: ["README.md"]
    merge:
    - type: ReplaceText
      substitutions:
        - text: "NAMESPACE"
          with: "#businessUnit"
    - let:
        - name: repoUrl
          expression: "T(org.springframework.web.util.UriComponentsBuilder).fromUriString('https://' + #bsGitRepository).build(true)"
      condition: "#bsGitRepository != null"
      merge:
      - type: ReplaceText
        substitutions:
          - text: "https://github.com/cdelashmutt-pivotal/terraform-accelerator"
            with: "#repoUrl.scheme + '://' + #repoUrl.host + '/' + #repoUrl.queryParams['owner'][0] + '/' + #repoUrl.queryParams['repo'][0]"
          - text: "branch: main"
            with: "'branch: ' + #bsGitBranch"

  - include: ["cluster/**/*"]
    merge:
    - type: ReplaceText
      substitutions:
        - text: "INGRESS-DOMAIN"
          with: "#businessUnit + '.azure.grogscave.net'"
        - text: "REGISTRY-SERVER"
          with: "#businessUnit + 'cdelashmuttvmware'"
        - text: "VIEW-CLUSTER-INGRESS-DOMAIN"
          with: "#centralClusterIngress"

  - include: ["**/*.tf"]
  
  - include: ["terraform/terraform.tfvars.off"]
    chain:
    - type: ReplaceText
      substitutions:
      - text: "EXAMPLE_PROJECT_NAME"
        with: "#businessUnit"
      - text: "TAP_PROFILE"
        with: "#devTapProfile"
      - text: "DEV_NETWORK"
        with: "#devNetwork"
    - type: RewritePath
      regex: "terraform/terraform.tfvars.off"
      rewriteTo: "'terraform/terraform.tfvars'"

  - include: ["catalog/**/*"]
    merge:
    - type: ReplaceText
      substitutions:
      - text: "GBS"
        with: "#businessUnit.toUpperCase()"
      - text: "gbs"
        with: "#businessUnit.toLowerCase()"